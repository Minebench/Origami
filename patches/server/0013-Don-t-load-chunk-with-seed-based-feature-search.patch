From f33ba85b1b27787e4d743759011228e08943091a Mon Sep 17 00:00:00 2001
From: Phoenix616 <mail@moep.tv>
Date: Mon, 13 Jan 2020 01:00:49 +0100
Subject: [PATCH] Don't load chunk with seed based feature search

---
 src/main/java/de/minebench/origami/OrigamiConfig.java     | 8 ++++++++
 .../world/level/levelgen/feature/StructureGenerator.java  | 7 +++++++
 2 files changed, 15 insertions(+)

diff --git a/src/main/java/de/minebench/origami/OrigamiConfig.java b/src/main/java/de/minebench/origami/OrigamiConfig.java
index efb0b1448..97bd2dfb8 100644
--- a/src/main/java/de/minebench/origami/OrigamiConfig.java
+++ b/src/main/java/de/minebench/origami/OrigamiConfig.java
@@ -116,6 +116,14 @@ public final class OrigamiConfig {
             return config.getDouble("worlds." + worldName + "." + path, config.getDouble("worlds.default." + path, dfl));
         }
 
+        public boolean fastFeatureSearchDontLoad = true;
+        private void fastFeatureSearch() {
+            fastFeatureSearchDontLoad = getBoolean("fast-feature-search-dont-load-chunk", fastFeatureSearchDontLoad);
+            if (fastFeatureSearchDontLoad) {
+                Bukkit.getLogger().info("Returning matching chunk from fast search directly instead of loading it.");
+            }
+        }
+
         public boolean onlyFindGeneratedFeatures = false;
         private void onlyGetGeneratedFeatures() {
             onlyFindGeneratedFeatures = getBoolean("only-find-generated-features", onlyFindGeneratedFeatures);
diff --git a/src/main/java/net/minecraft/world/level/levelgen/feature/StructureGenerator.java b/src/main/java/net/minecraft/world/level/levelgen/feature/StructureGenerator.java
index f18a66176..b50ab09ea 100644
--- a/src/main/java/net/minecraft/world/level/levelgen/feature/StructureGenerator.java
+++ b/src/main/java/net/minecraft/world/level/levelgen/feature/StructureGenerator.java
@@ -184,6 +184,13 @@ public abstract class StructureGenerator<C extends WorldGenFeatureConfiguration>
                                 }
                             }
                             // Paper end
+                            // Origami start - seed based feature search doesn't load
+                            if (iworldreader instanceof net.minecraft.world.level.World
+                                    && ((net.minecraft.world.level.World) iworldreader).origamiConfig.fastFeatureSearchDontLoad
+                                    && !((net.minecraft.world.level.World) iworldreader).isLoaded(blockposition)) {
+                                return chunkcoordintpair.asPosition().add(8, blockposition.getY(), 8);
+                            }
+                            // Origami end
                             // Origami start - option to only find generated features to not generate new chunks
                             IChunkAccess ichunkaccess = iworldreader.getChunkAt(chunkcoordintpair.x, chunkcoordintpair.z, ChunkStatus.STRUCTURE_STARTS, !(iworldreader instanceof net.minecraft.world.level.World) || !((net.minecraft.world.level.World) iworldreader).origamiConfig.onlyFindGeneratedFeatures);
                             if (ichunkaccess == null) {
-- 
2.25.1.windows.1


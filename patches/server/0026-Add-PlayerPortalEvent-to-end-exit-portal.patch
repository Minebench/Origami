From fe7f8e65f01dd55ac9457f9a49b516ec4c11849b Mon Sep 17 00:00:00 2001
From: Phoenix616 <mail@moep.tv>
Date: Mon, 20 Jan 2020 18:51:00 +0100
Subject: [PATCH] Add PlayerPortalEvent to end exit portal

---
 .../java/net/minecraft/server/EntityPlayer.java     | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 296d52d8..f668a7a5 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -792,6 +792,19 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         DimensionManager dimensionmanager1 = this.dimension;
 
         if (dimensionmanager1.getType() == DimensionManager.THE_END && dimensionmanager.getType() == DimensionManager.OVERWORLD) { // CraftBukkit - getType()
+            // Origami start - add PlayerPortalEvent to leaving the end
+            Location exit = this.getBukkitEntity().getBedSpawnLocation();
+            PlayerPortalEvent event = new PlayerPortalEvent(this.getBukkitEntity(), this.getBukkitEntity().getLocation(), exit, new org.bukkit.craftbukkit.CraftTravelAgent(0), cause);
+            event.useTravelAgent(false);
+            Bukkit.getServer().getPluginManager().callEvent(event);
+            if (event.isCancelled()) {
+                return null;
+            }
+
+            if (event.getTo() == null || !event.getTo().equals(this.getBukkitEntity().getBedSpawnLocation())) {
+                this.getBukkitEntity().setBedSpawnLocation(event.getTo(), true);
+            }
+            // Origami end
             this.worldChangeInvuln = true; // CraftBukkit - Moved down from above
             this.decouple();
             this.getWorldServer().removePlayer(this);
-- 
2.18.0.windows.1


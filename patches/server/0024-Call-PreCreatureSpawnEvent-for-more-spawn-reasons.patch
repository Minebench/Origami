From 0b82278196414324b7631b8a62b2548fcddd2b4f Mon Sep 17 00:00:00 2001
From: Phoenix616 <mail@moep.tv>
Date: Fri, 3 Jan 2020 16:28:31 +0100
Subject: [PATCH] Call PreCreatureSpawnEvent for more spawn reasons

---
 .../java/net/minecraft/server/EntityTypes.java     | 10 ++++++++++
 .../java/net/minecraft/server/EntityVillager.java  | 14 ++++++++++++++
 2 files changed, 24 insertions(+)

diff --git a/src/main/java/net/minecraft/server/EntityTypes.java b/src/main/java/net/minecraft/server/EntityTypes.java
index 612b9b7e..6fa962f6 100644
--- a/src/main/java/net/minecraft/server/EntityTypes.java
+++ b/src/main/java/net/minecraft/server/EntityTypes.java
@@ -166,6 +166,16 @@ public class EntityTypes<T extends Entity> {
 
     @Nullable
     public T spawnCreature(World world, @Nullable NBTTagCompound nbttagcompound, @Nullable IChatBaseComponent ichatbasecomponent, @Nullable EntityHuman entityhuman, BlockPosition blockposition, EnumMobSpawn enummobspawn, boolean flag, boolean flag1, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason spawnReason) {
+        // Origami start - Call PreCreatureSpawnEvent for more spawn reasons
+        org.bukkit.entity.EntityType type = org.bukkit.entity.EntityType.fromName(EntityTypes.getName(this).getKey());
+        if (type != null) {
+            if (!new com.destroystokyo.paper.event.entity.PreCreatureSpawnEvent(
+                    MCUtil.toLocation(world, blockposition), type, spawnReason
+            ).callEvent()) {
+                return null;
+            }
+        }
+        // Origami end
         T t0 = this.b(world, nbttagcompound, ichatbasecomponent, entityhuman, blockposition, enummobspawn, flag, flag1);
 
         return world.addEntity(t0, spawnReason) ? t0 : null; // Don't return an entity when CreatureSpawnEvent is canceled
diff --git a/src/main/java/net/minecraft/server/EntityVillager.java b/src/main/java/net/minecraft/server/EntityVillager.java
index 7f747fac..c925a4d6 100644
--- a/src/main/java/net/minecraft/server/EntityVillager.java
+++ b/src/main/java/net/minecraft/server/EntityVillager.java
@@ -908,6 +908,20 @@ public class EntityVillager extends EntityVillagerAbstract implements Reputation
                 }
 
                 BlockPosition blockposition2 = blockposition.a(d0, d2, d1);
+                // Origami start - Call PreCreatureSpawnEvent for more spawn reasons
+                org.bukkit.entity.EntityType type = org.bukkit.entity.EntityType.fromName(EntityTypes.getName(EntityTypes.IRON_GOLEM).getKey());
+                if (type != null) {
+                    com.destroystokyo.paper.event.entity.PreCreatureSpawnEvent event = new com.destroystokyo.paper.event.entity.PreCreatureSpawnEvent(
+                            MCUtil.toLocation(world, blockposition), type, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.VILLAGE_DEFENSE
+                    );
+                    if (!event.callEvent()) {
+                        if (event.shouldAbortSpawn()) {
+                            return null;
+                        }
+                        break;
+                    }
+                }
+                // Origami end
                 EntityIronGolem entityirongolem = (EntityIronGolem) EntityTypes.IRON_GOLEM.b(this.world, (NBTTagCompound) null, (IChatBaseComponent) null, (EntityHuman) null, blockposition2, EnumMobSpawn.MOB_SUMMONED, false, false);
 
                 if (entityirongolem != null) {
-- 
2.18.0.windows.1


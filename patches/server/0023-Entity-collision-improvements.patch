From 992ade8a7eab0c0a0bd5652a6a9aaff6f5fa8bc2 Mon Sep 17 00:00:00 2001
From: Phoenix616 <mail@moep.tv>
Date: Fri, 10 Apr 2020 22:11:26 +0100
Subject: [PATCH] Entity collision improvements

---
 .../net/minecraft/server/EntityHorseAbstract.java    |  2 +-
 src/main/java/net/minecraft/server/EntityLiving.java |  4 +++-
 src/main/java/net/minecraft/server/EntityParrot.java |  2 +-
 .../bukkit/craftbukkit/entity/CraftLivingEntity.java | 12 ++++++++++++
 4 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityHorseAbstract.java b/src/main/java/net/minecraft/server/EntityHorseAbstract.java
index c56efe035a..36c02e7f6a 100644
--- a/src/main/java/net/minecraft/server/EntityHorseAbstract.java
+++ b/src/main/java/net/minecraft/server/EntityHorseAbstract.java
@@ -162,7 +162,7 @@ public abstract class EntityHorseAbstract extends EntityAnimal implements IInven
 
     @Override
     public boolean isCollidable() {
-        return !this.isVehicle();
+        return super.isCollidable() && !this.isVehicle(); // Origami - fix setCollidable being broken for Horses
     }
 
     private void eq() {
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 3fc2360a10..a77aa71c11 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -128,6 +128,7 @@ public abstract class EntityLiving extends Entity {
     boolean forceDrops;
     ArrayList<org.bukkit.inventory.ItemStack> drops = new ArrayList<org.bukkit.inventory.ItemStack>();
     public org.bukkit.craftbukkit.attribute.CraftAttributeMap craftAttributes;
+    public boolean canCollide = true; // Origami - canCollide API
     public boolean collides = true;
     public boolean canPickUpLoot;
     public org.bukkit.craftbukkit.entity.CraftLivingEntity getBukkitLivingEntity() { return (org.bukkit.craftbukkit.entity.CraftLivingEntity) super.getBukkitEntity(); } // Paper
@@ -2682,6 +2683,7 @@ public abstract class EntityLiving extends Entity {
             return;
         }
         // Paper - end don't run getEntities if we're not going to use its result
+        if (!this.canCollide) return; // Origami - canCollide API
         List<Entity> list = this.world.getEntities(this, this.getBoundingBox(), IEntitySelector.a(this));
 
         if (!list.isEmpty()) {
@@ -2812,7 +2814,7 @@ public abstract class EntityLiving extends Entity {
 
     @Override
     public boolean isCollidable() {
-        return this.isAlive() && !this.isClimbing() && this.collides; // CraftBukkit
+        return this.isAlive() && !this.isClimbing() && this.collides && this.canCollide; // CraftBukkit // Origami - canCollide API
     }
 
     @Override
diff --git a/src/main/java/net/minecraft/server/EntityParrot.java b/src/main/java/net/minecraft/server/EntityParrot.java
index 1402087612..132b236bde 100644
--- a/src/main/java/net/minecraft/server/EntityParrot.java
+++ b/src/main/java/net/minecraft/server/EntityParrot.java
@@ -320,7 +320,7 @@ public class EntityParrot extends EntityPerchable implements EntityBird {
 
     @Override
     public boolean isCollidable() {
-        return true;
+        return super.isCollidable(); // Origami - fix setCollidable being broken for Parots
     }
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
index 245bd116d1..80930c3c14 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
@@ -663,6 +663,18 @@ public class CraftLivingEntity extends CraftEntity implements LivingEntity {
         getHandle().a(EnumHand.OFF_HAND, true); // PAIL rename swingHand
     }
 
+    // Origami start - canCollide API
+    @Override
+    public void setCanCollide(boolean canCollide) {
+        getHandle().canCollide = canCollide;
+    }
+
+    @Override
+    public boolean canCollide() {
+        return getHandle().canCollide;
+    }
+    // Origami end
+
     @Override
     public void setCollidable(boolean collidable) {
         getHandle().collides = collidable;
-- 
2.25.1.windows.1

